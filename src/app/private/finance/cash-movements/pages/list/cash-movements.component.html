<div class="flex flex-column h-screen bg-blue-50 font-family relative">
  <!-- 1. HEADER (Fijo arriba) -->
  <div class="surface-card shadow-2 p-3 z-2 relative">
    <div
      class="flex flex-column md:flex-row justify-content-between align-items-center gap-3">
      <!-- Título -->
      <div>
        <h1 class="text-xl font-bold text-900 m-0">Control de Caja</h1>
        <div class="text-sm text-500 mt-1">
          Estado: <span class="text-green-600 font-bold">ABIERTO</span>
        </div>
      </div>

      <!-- Navegación Fecha -->
      <div class="flex align-items-center surface-100 border-round-xl p-1">
        <button
          pButton
          icon="pi pi-chevron-left"
          class="p-button-text p-button-rounded text-600"
          (click)="changeDate(-1)"></button>

        <div
          class="flex flex-column align-items-center px-4 cursor-pointer w-12rem">
          <span class="text-xs font-bold text-500 uppercase">Visualizando</span>
          <span class="font-bold text-800">{{
            currentDate | date: 'dd MMM, yyyy'
          }}</span>
        </div>

        <button
          pButton
          icon="pi pi-chevron-right"
          class="p-button-text p-button-rounded text-600"
          (click)="changeDate(1)"></button>
      </div>

      <!-- Botones Acción -->
      <div class="flex gap-2">
        <button
          pButton
          label="Ingreso"
          icon="pi pi-plus-circle"
          class="p-button-success p-button-outlined font-bold border-round-xl"
          (click)="openModal('INCOME')"></button>
        <button
          pButton
          label="Gasto"
          icon="pi pi-minus-circle"
          class="p-button-danger p-button-outlined font-bold border-round-xl"
          (click)="openModal('EXPENSE')"></button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="flex gap-2 mt-3 overflow-x-auto pb-1">
      <span class="text-xs font-bold text-400 uppercase mr-1 align-self-center"
        >Filtros:</span
      >

      <div
        class="cursor-pointer border-1 border-round-lg px-3 py-1 text-xs font-bold flex align-items-center gap-2 transition-colors"
        [ngClass]="
          filters.cash
            ? 'bg-blue-50 border-blue-500 text-blue-700'
            : 'surface-card border-300 text-500'
        "
        (click)="filters.cash = !filters.cash">
        <i class="pi pi-money-bill"></i> CASH
      </div>

      <div
        class="cursor-pointer border-1 border-round-lg px-3 py-1 text-xs font-bold flex align-items-center gap-2 transition-colors"
        [ngClass]="
          filters.yape
            ? 'bg-blue-50 border-blue-500 text-blue-700'
            : 'surface-card border-300 text-500'
        "
        (click)="filters.yape = !filters.yape">
        <i class="pi pi-mobile"></i> YAPE/PLIN
      </div>

      <div
        class="cursor-pointer border-1 border-round-lg px-3 py-1 text-xs font-bold flex align-items-center gap-2 transition-colors"
        [ngClass]="
          filters.card
            ? 'bg-blue-50 border-blue-500 text-blue-700'
            : 'surface-card border-300 text-500'
        "
        (click)="filters.card = !filters.card">
        <i class="pi pi-credit-card"></i> CARD
      </div>
    </div>
  </div>

  <!-- 2. TABLA MOVIMIENTOS (Scrollable) -->
  <!-- Agregamos pb-8 (padding bottom) grande para que el contenido no quede oculto tras el footer fixed -->
  <div class="flex-1 overflow-y-auto p-3 pb-8 mb-6">
    <div class="surface-card border-round-xl shadow-1 overflow-hidden">
      <table class="w-full text-sm" style="border-collapse: collapse">
        <thead
          class="surface-100 text-500 border-bottom-1 border-200 uppercase text-xs font-bold sticky top-0 z-1">
          <tr>
            <th class="p-3 text-left w-6rem">Hora</th>
            <th class="p-3 text-center w-3rem">Tipo</th>
            <th class="p-3 text-left">Descripción</th>
            <th class="p-3 text-center w-8rem">Método</th>
            <th class="p-3 text-right w-8rem">Monto</th>
          </tr>
        </thead>
        <tbody class="text-700">
          <!-- SECCIÓN VENTAS -->
          <tr class="surface-50 border-bottom-1 border-100">
            <td
              colspan="5"
              class="p-2 pl-3 text-xs font-bold text-indigo-600 uppercase">
              <i class="pi pi-shopping-bag mr-2"></i> Ventas del Día
            </td>
          </tr>
          @for (item of filteredList('sales'); track item.id) {
            <tr
              class="border-bottom-1 surface-border hover:surface-50 transition-colors">
              <td class="p-3 font-mono text-xs text-500">{{ item.time }}</td>
              <td class="p-3 text-center">
                <i class="pi pi-arrow-down text-green-500"></i>
              </td>
              <!-- Ajuste de estilo para descripción larga -->
              <td class="p-3">
                <div class="font-bold text-800 text-xs line-height-3">
                  {{ item.description }}
                </div>
              </td>
              <td class="p-3 text-center">
                <span
                  class="text-xs font-bold px-2 py-1 border-round surface-200 text-700"
                  >{{ item.method }}</span
                >
              </td>
              <td class="p-3 text-right font-bold text-green-600">
                + {{ item.amount | number: '1.2-2' }}
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="5" class="p-3 text-center text-500 text-xs italic">
                No hay ventas registradas
              </td>
            </tr>
          }

          <!-- SECCIÓN INGRESOS -->
          <tr class="surface-50 border-bottom-1 border-100">
            <td
              colspan="5"
              class="p-2 pl-3 text-xs font-bold text-green-600 uppercase">
              <i class="pi pi-plus-circle mr-2"></i> Otros Ingresos
            </td>
          </tr>
          @for (item of filteredList('incomes'); track item.id) {
            <tr class="border-bottom-1 surface-border hover:surface-50">
              <td class="p-3 font-mono text-xs text-500">{{ item.time }}</td>
              <td class="p-3 text-center">
                <i class="pi pi-plus text-green-500"></i>
              </td>
              <td class="p-3 font-bold text-800">{{ item.description }}</td>
              <td class="p-3 text-center">
                <span
                  class="text-xs font-bold px-2 py-1 border-round surface-200 text-700"
                  >{{ item.method }}</span
                >
              </td>
              <td class="p-3 text-right font-bold text-green-600">
                + {{ item.amount | number: '1.2-2' }}
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="5" class="p-3 text-center text-500 text-xs italic">
                No hay ingresos extra
              </td>
            </tr>
          }

          <!-- SECCIÓN GASTOS -->
          <tr class="surface-50 border-bottom-1 border-100">
            <td
              colspan="5"
              class="p-2 pl-3 text-xs font-bold text-red-600 uppercase">
              <i class="pi pi-minus-circle mr-2"></i> Gastos
            </td>
          </tr>
          @for (item of filteredList('expenses'); track item.id) {
            <tr class="border-bottom-1 surface-border hover:surface-50">
              <td class="p-3 font-mono text-xs text-500">{{ item.time }}</td>
              <td class="p-3 text-center">
                <i class="pi pi-minus text-red-500"></i>
              </td>
              <td class="p-3 font-bold text-800">{{ item.description }}</td>
              <td class="p-3 text-center">
                <span
                  class="text-xs font-bold px-2 py-1 border-round surface-200 text-700"
                  >{{ item.method }}</span
                >
              </td>
              <td class="p-3 text-right font-bold text-red-600">
                - {{ item.amount | number: '1.2-2' }}
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="5" class="p-3 text-center text-500 text-xs italic">
                No hay gastos
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- 3. FOOTER TOTALES (FIXED BOTTOM) -->
  <!-- Usamos 'fixed bottom-0 left-0 w-full' para anclarlo visualmente -->
  <div
    class="fixed bottom-0 left-0 w-full surface-900 text-0 p-3 z-5 shadow-top-2">
    <div
      class="flex flex-column md:flex-row justify-content-between align-items-center gap-3 max-w-7xl mx-auto">
      <div class="flex gap-5 text-sm">
        <div class="text-400">
          <span class="block text-xs font-bold uppercase mb-1">Caja Base</span>
          <span class="font-mono text-xl font-bold text-white"
            >S/ {{ summary().opening_balance | number: '1.2-2' }}</span
          >
        </div>
        <div class="text-400 border-left-1 border-700 pl-4">
          <span class="block text-xs font-bold uppercase mb-1"
            >Operaciones</span
          >
          <span
            class="font-mono text-xl font-bold"
            [class.text-green-400]="netOperations() >= 0"
            [class.text-red-400]="netOperations() < 0">
            {{ netOperations() >= 0 ? '+' : '' }} S/
            {{ netOperations() | number: '1.2-2' }}
          </span>
        </div>
      </div>

      <div
        class="flex align-items-center gap-3 surface-800 px-4 py-2 border-round-xl border-1 border-700">
        <span class="text-xs font-bold text-400 uppercase">Total en Caja</span>
        <span class="text-3xl font-black text-white"
          >S/ {{ summary().final_balance | number: '1.2-2' }}</span
        >
      </div>
    </div>
  </div>
</div>

<!-- DIALOGOS / MODALES -->
<p-dialog
  [(visible)]="showModal"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [header]="modalType === 'INCOME' ? 'Registrar Ingreso' : 'Registrar Gasto'"
  [style]="{ width: '90%', maxWidth: '400px' }"
  styleClass="p-fluid">
  <div class="flex flex-column gap-3 pt-2">
    <!-- Botones Rápidos (Solo gastos) -->
    @if (modalType === 'EXPENSE') {
      <span class="text-xs font-bold text-500 uppercase"
        >Gastos Recurrentes</span
      >
      <div class="grid grid-nogutter gap-2">
        <div class="col">
          <button
            pButton
            class="p-button-outlined p-button-secondary text-sm flex flex-column py-2 h-full"
            (click)="setQuickExpense('Pasaje', 4)">
            <i class="pi pi-car text-xl mb-1"></i>
            <span>Pasaje</span>
            <span class="text-xs font-bold surface-200 px-2 border-round mt-1"
              >S/ 4</span
            >
          </button>
        </div>
        <div class="col">
          <button
            pButton
            class="p-button-outlined p-button-secondary text-sm flex flex-column py-2 h-full"
            (click)="setQuickExpense('Almuerzo', 10)">
            <i class="pi pi-apple text-xl mb-1"></i>
            <span>Almuerzo</span>
            <span class="text-xs font-bold surface-200 px-2 border-round mt-1"
              >S/ 10</span
            >
          </button>
        </div>
        <div class="col">
          <button
            pButton
            class="p-button-outlined p-button-secondary text-sm flex flex-column py-2 h-full"
            (click)="setQuickExpense('Vigilancia', 1)">
            <i class="pi pi-shield text-xl mb-1"></i>
            <span>Vigilancia</span>
            <span class="text-xs font-bold surface-200 px-2 border-round mt-1"
              >S/ 1</span
            >
          </button>
        </div>
      </div>
      <div class="border-top-1 border-200 my-1"></div>
    }

    <!-- Inputs -->
    <div>
      <span class="block text-500 font-bold text-sm mb-1">Descripción</span>
      <input
        pInputText
        [(ngModel)]="movementForm.description"
        placeholder="Ej: Pago de servicios" />
    </div>
    <div>
      <span class="block text-500 font-bold text-sm mb-1">Monto (S/)</span>
      <p-inputNumber
        [(ngModel)]="movementForm.amount"
        mode="currency"
        currency="PEN"
        locale="es-PE"
        placeholder="0.00"
        [min]="0"
        styleClass="font-bold text-lg"></p-inputNumber>
    </div>

    <button
      pButton
      [label]="modalType === 'INCOME' ? 'Guardar Ingreso' : 'Confirmar Gasto'"
      [class]="modalType === 'INCOME' ? 'p-button-success' : 'p-button-danger'"
      class="mt-2 font-bold py-3"
      (click)="saveMovement()"
      [disabled]="!movementForm.amount || !movementForm.description"></button>
  </div>
</p-dialog>
