@if (form) {
  <form [formGroup]="form" (ngSubmit)="buttonSaveSale()">
    <div class="p-fluid p-formgrid grid">
      <!-- 1. FECHA -->
      <div class="col-12">
        <app-input-date
          label="Fecha"
          for="creationTime"
          controlName="creationTime"></app-input-date>
      </div>

      <!-- 2. ITEMS (Edición de Precios) -->
      <div class="col-12">
        <span class="block text-500 font-bold mb-2 text-sm uppercase"
          >Productos</span
        >
        <div
          class="border-1 border-200 border-round-xl overflow-hidden"
          formArrayName="items">
          <table class="w-full text-sm">
            <thead class="surface-100 border-bottom-1 border-200">
              <tr>
                <th class="p-2 text-left">Cant.</th>
                <th class="p-2 text-left">Desc.</th>
                <th class="p-2 text-right w-6rem">Precio</th>
                <th class="p-2 text-right">Sub.</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let item of itemsControls; let i = index">
                <tr [formGroupName]="i" class="border-bottom-1 surface-border">
                  <td class="p-2 text-center font-bold">
                    {{ item.get('quantity')?.value }}
                  </td>
                  <td class="p-2">
                    <div class="font-bold text-xs">
                      {{ item.get('description_full')?.value }}
                    </div>
                  </td>
                  <td class="p-2">
                    <input
                      type="number"
                      pInputText
                      formControlName="unit_price"
                      class="w-full text-right p-1 h-2rem text-sm" />
                  </td>
                  <td class="p-2 text-right font-bold">
                    {{ item.get('subtotal')?.value | number: '1.2-2' }}
                  </td>
                </tr>
              </ng-container>
            </tbody>
            <tfoot class="surface-50">
              <tr>
                <td colspan="3" class="p-2 text-right font-bold">
                  Total Venta
                </td>
                <td class="p-2 text-right font-black text-indigo-700">
                  {{ calculatedTotal | number: '1.2-2' }}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- 3. PAGOS (Edición Mixta) -->
      <div class="col-12 mb-3">
        <div class="flex justify-content-between align-items-center mb-2">
          <span class="text-500 font-bold text-sm uppercase">Pagos</span>
          <button
            type="button"
            pButton
            icon="pi pi-plus"
            label="Agregar Pago"
            class="p-button-text p-button-sm py-1"
            (click)="addPaymentRow()"></button>
        </div>

        <div formArrayName="payments" class="flex flex-column gap-2">
          <div
            *ngFor="let pay of paymentsControls; let i = index"
            [formGroupName]="i"
            class="flex gap-2 align-items-center">
            <!-- Selector Método -->
            <p-dropdown
              [options]="paymentMethodsList"
              formControlName="method"
              class="w-full"
              styleClass="w-full text-sm"></p-dropdown>

            <!-- Monto -->
            <div class="p-inputgroup w-8rem">
              <span class="p-inputgroup-addon py-1 px-2 text-xs">S/</span>
              <input
                type="number"
                pInputText
                formControlName="amount"
                class="text-right p-1 text-sm font-bold" />
            </div>

            <!-- Eliminar -->
            <button
              type="button"
              pButton
              icon="pi pi-trash"
              class="p-button-danger p-button-text p-button-rounded"
              (click)="removePayment(i)"
              [disabled]="paymentsControls.length === 1"></button>
          </div>
        </div>

        <!-- Resumen Pagos -->
        <div
          class="flex justify-content-between mt-2 p-2 border-round"
          [ngClass]="
            calculatedTotal - calculatedPayments > 0.1
              ? 'bg-red-50 text-red-600'
              : 'bg-green-50 text-green-700'
          ">
          <span class="text-xs font-bold uppercase"
            >Total Pagado: S/ {{ calculatedPayments | number: '1.2-2' }}</span
          >
          <span
            class="text-xs font-bold"
            *ngIf="calculatedTotal - calculatedPayments > 0.1">
            Falta: S/
            {{ calculatedTotal - calculatedPayments | number: '1.2-2' }}
          </span>
          <span
            class="text-xs font-bold"
            *ngIf="calculatedTotal - calculatedPayments < -0.1">
            Sobran: S/
            {{ calculatedPayments - calculatedTotal | number: '1.2-2' }}
          </span>
          <!-- FIX: Reemplazamos Math.abs() por una comparación lógica directa -->
          <span
            class="text-xs font-bold flex align-items-center gap-1"
            *ngIf="
              calculatedTotal - calculatedPayments <= 0.1 &&
              calculatedTotal - calculatedPayments >= -0.1
            ">
            <i class="pi pi-check-circle"></i> Correcto
          </span>
        </div>
      </div>

      <button
        type="submit"
        pButton
        label="Guardar Todo"
        class="mt-4 w-full p-button-primary font-bold shadow-2"
        autofocus
        [disabled]="!isFormValid"></button>
    </div>
  </form>
}
