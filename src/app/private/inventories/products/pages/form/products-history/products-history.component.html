<div class="w-full h-full" style="min-height: 400px">
  <!-- LOADING -->
  @if (loading()) {
    <div
      class="flex flex-column align-items-center justify-content-center p-6 gap-3 text-500">
      <i class="pi pi-spin pi-spinner text-4xl"></i>
      <span>Cargando historial...</span>
    </div>
  } @else if (events().length === 0) {
    <!-- VACÍO -->
    <div
      class="flex flex-column align-items-center justify-content-center p-6 gap-3 text-400">
      <i class="pi pi-history text-5xl opacity-50"></i>
      <span>No hay movimientos registrados para este producto.</span>
    </div>
  } @else {
    <!-- TIMELINE -->
    <div class="px-2 py-4">
      <p-timeline [value]="events()" align="left" styleClass="w-full">
        <!-- MARCADOR (ÍCONO) -->
        <ng-template pTemplate="marker" let-event>
          <span
            class="custom-marker shadow-2"
            [ngClass]="{
              'bg-green-500': event.severity === 'success',
              'bg-blue-500': event.severity === 'info',
              'bg-red-500': event.severity === 'danger',
              'bg-gray-500': event.severity === 'secondary',
            }">
            <i [class]="event.icon"></i>
          </span>
        </ng-template>

        <!-- CONTENIDO -->
        <ng-template pTemplate="content" let-event>
          <div
            class="surface-card border-1 border-200 border-round p-3 mb-3 shadow-1">
            <!-- Header del Evento -->
            <div class="flex justify-content-between align-items-start mb-2">
              <div>
                <span class="block font-bold text-900 text-sm">{{
                  event.action_title
                }}</span>
                <span
                  class="text-xs text-500 flex align-items-center gap-1 mt-1">
                  <i class="pi pi-user"></i> {{ event.user }}
                </span>
              </div>
              <div class="text-right">
                <span class="block text-xs font-bold text-700">{{
                  event.date
                }}</span>
                <span class="text-xs text-500">{{ event.time }}</span>
              </div>
            </div>

            <!-- Detalles de Cambios (Tabla pequeña) -->
            @if (event.changes && event.changes.length > 0) {
              <div class="surface-50 border-round p-2 mt-2">
                <div
                  class="grid grid-nogutter text-xs font-bold text-500 mb-1 px-2">
                  <div class="col-4">Campo</div>
                  <div class="col-4 text-center">Antes</div>
                  <div class="col-4 text-right">Ahora</div>
                </div>
                <div class="flex flex-column gap-1">
                  @for (change of event.changes; track change.field) {
                    <div
                      class="grid grid-nogutter text-sm px-2 py-1 border-bottom-1 surface-border">
                      <div class="col-4 font-medium text-700">
                        {{ change.field }}
                      </div>
                      <div class="col-4 text-center text-red-400">
                        {{ change.from }}
                      </div>
                      <div class="col-4 text-right font-bold text-green-600">
                        {{ change.to }}
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </ng-template>
      </p-timeline>
    </div>
  }
</div>
