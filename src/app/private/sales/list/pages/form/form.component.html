@if (form) {
  <form [formGroup]="form" (ngSubmit)="buttonSaveSale()">
    <div class="p-fluid p-formgrid grid">
      <!-- Campo Fecha -->
      <div class="col-12 mb-3">
        <app-input-date
          label="Fecha de Venta"
          for="creationTime"
          type="text"
          id="creationTime"
          placeholder="Ingresa la fecha"
          controlName="creationTime"></app-input-date>
      </div>

      <!-- SECCIÓN INFORMATIVA -->
      @if (saleDetails) {
        <!-- 1. Desglose de Pagos (Solo lectura, referencia visual) -->
        <div class="col-12 mb-2">
          <span class="block text-500 font-bold mb-2 text-sm uppercase"
            >Métodos de Pago</span
          >
          <div class="flex flex-wrap gap-2">
            @for (pay of saleDetails.payments; track pay.id) {
              <div
                class="border-1 border-round-lg p-2 px-3 surface-card flex align-items-center gap-2 shadow-1">
                <i
                  class="pi text-lg"
                  [ngClass]="{
                    'pi-money-bill text-green-600': pay.method === 'CASH',
                    'pi-mobile text-purple-600':
                      pay.method === 'YAPE' || pay.method === 'PLIN',
                    'pi-credit-card text-orange-600': pay.method === 'CARD',
                  }"></i>
                <span class="font-bold text-700 text-sm"
                  >{{ pay.method }}:</span
                >
                <span class="text-900 font-bold"
                  >S/ {{ pay.amount | number: '1.2-2' }}</span
                >
              </div>
            } @empty {
              <!-- Fallback por si la venta no tiene pagos registrados -->
              <div class="text-gray-500 text-sm font-italic">
                Pago único: {{ saleDetails.paymentMethod }}
              </div>
            }
          </div>

          <!-- Alerta visual si el total recalculado difiere del pago registrado -->
          @if (calculatedTotal !== saleDetails.total) {
            <div
              class="mt-2 text-xs text-orange-600 font-bold flex align-items-center gap-1 fadein-animation">
              <i class="pi pi-exclamation-triangle"></i>
              <span
                >Atención: El nuevo total (S/
                {{ calculatedTotal | number: '1.2-2' }}) difiere del monto
                original pagado.</span
              >
            </div>
          }
        </div>

        <!-- 2. Tabla de Productos Editable -->
        <div class="col-12 mt-2">
          <span class="block text-500 font-bold mb-2 text-sm uppercase"
            >Edición de Precios</span
          >

          <div
            class="border-1 border-200 border-round-xl overflow-hidden"
            formArrayName="items">
            <table class="w-full text-sm" style="border-collapse: collapse">
              <thead class="surface-100 text-600 border-bottom-1 border-200">
                <tr>
                  <th class="p-2 pl-3 text-left font-bold w-3rem">Cant.</th>
                  <th class="p-2 text-left font-bold">Descripción</th>
                  <th class="p-2 text-right font-bold w-8rem">P. Unitario</th>
                  <th class="p-2 text-right font-bold w-7rem">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                <!-- Iteramos sobre los CONTROLES del formulario -->
                <ng-container
                  *ngFor="let itemGroup of itemsControls; let i = index">
                  <tr
                    [formGroupName]="i"
                    class="border-bottom-1 surface-border hover:surface-50 transition-colors">
                    <!-- Cantidad (Solo lectura visual) -->
                    <td
                      class="p-2 pl-3 font-bold text-900 text-center vertical-align-middle">
                      {{ itemGroup.get('quantity')?.value }}
                    </td>

                    <!-- Descripción -->
                    <td class="p-2 vertical-align-middle">
                      <div class="font-bold text-800">
                        {{ itemGroup.get('product_name')?.value }}
                      </div>
                      <div class="text-xs text-500">
                        {{ itemGroup.get('size')?.value }} •
                        {{ itemGroup.get('color')?.value }}
                      </div>
                    </td>

                    <!-- PRECIO EDITABLE -->
                    <td class="p-2 text-right vertical-align-middle">
                      <div
                        class="flex align-items-center justify-content-end gap-1">
                        <span class="text-xs text-500 font-bold">S/</span>
                        <input
                          type="number"
                          pInputText
                          formControlName="unit_price"
                          class="w-full text-right font-bold p-1 h-2rem text-sm border-1 border-300 border-round hover:border-indigo-500 focus:border-indigo-500 outline-none transition-colors" />
                      </div>
                    </td>

                    <!-- Subtotal Calculado (Dinámico) -->
                    <td
                      class="p-2 text-right font-bold text-900 pr-3 vertical-align-middle">
                      S/
                      {{ itemGroup.get('subtotal')?.value | number: '1.2-2' }}
                    </td>
                  </tr>
                </ng-container>
              </tbody>

              <!-- Footer Total Dinámico -->
              <tfoot class="surface-50 border-top-2 border-200">
                <tr>
                  <td
                    colspan="3"
                    class="p-2 text-right font-bold text-600 uppercase text-xs vertical-align-middle">
                    Nuevo Total Venta
                  </td>
                  <td
                    class="p-2 text-right font-black text-lg text-indigo-700 pr-3 vertical-align-middle">
                    S/ {{ calculatedTotal | number: '1.2-2' }}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      }

      <button
        type="submit"
        pButton
        label="Guardar Cambios"
        class="mt-4 w-full p-button-primary font-bold shadow-2 text-base py-3"
        [disabled]="!isValid"></button>
    </div>
  </form>
}
